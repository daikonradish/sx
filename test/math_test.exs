defmodule MathTest do
  use ExUnit.Case
  doctest Math

  test "n choose k" do
    assert Math.choose(25, 3) == 2300
    assert Math.choose(50, 8) == 536_878_650
    assert Math.choose(100, 0) == 1
    assert Math.choose(100, 100) == 1
  end

  test "integer exponent" do
    assert Math.exponentiate_int(2, 2) == 4
    assert Math.exponentiate_int(2, 5) == 32
    assert Math.exponentiate_int(0.5, 10) == 0.0009765625
    assert_in_delta(Math.exponentiate_int(0.5, 100_000), 0.0, 0.00001)
  end

  test "loggamma" do
    assert_in_delta(Math.loggamma(12), 17.502307845873887, 0.001)
    assert_in_delta(Math.loggamma(12313), 103_652.10307512584, 0.001)
    assert_in_delta(Math.loggamma(0.3), 1.0957979948180754, 0.001)
    assert_in_delta(Math.loggamma(0.05), 2.968879201051731, 0.001)
  end

  test "factorial" do
    assert Math.factorial(10) == 3_628_800
  end

  test "incomplete beta" do
    assert_in_delta(Math.incomplete_beta(10, 10, 0.1), 0.00000, 0.001)
    assert_in_delta(Math.incomplete_beta(10, 10, 0.3), 0.03255, 0.001)
    assert_in_delta(Math.incomplete_beta(10, 10, 0.5), 0.50000, 0.001)
    assert_in_delta(Math.incomplete_beta(10, 10, 0.7), 0.96744, 0.001)

    assert_in_delta(Math.incomplete_beta(15, 10, 0.5), 0.15373, 0.001)
    assert_in_delta(Math.incomplete_beta(15, 10, 0.6), 0.48908, 0.001)

    assert_in_delta(Math.incomplete_beta(10, 15, 0.5), 0.84627, 0.001)
    assert_in_delta(Math.incomplete_beta(10, 15, 0.6), 0.97834, 0.001)

    assert_in_delta(Math.incomplete_beta(20, 20, 0.4), 0.10206, 0.001)
    assert_in_delta(Math.incomplete_beta(40, 40, 0.4), 0.03581, 0.001)
    assert_in_delta(Math.incomplete_beta(40, 40, 0.7), 0.9999, 0.001)
  end

  test "inverse incomplete beta" do
    # implementation uses incomplete_Beta
    test_cases = [
      # Edge cases
      {1.0, 1.0, 0.0, 0.0, "Edge: p=0"},
      {1.0, 1.0, 1.0, 1.0, "Edge: p=1"},
      {2.0, 3.0, 0.0, 0.0, "Edge: p=0 with non-uniform"},
      {2.0, 3.0, 1.0, 1.0, "Edge: p=1 with non-uniform"},

      # Uniform distribution {a=1, b=1}
      {1.0, 1.0, 0.25, 0.25, "Uniform: p=0.25"},
      {1.0, 1.0, 0.5, 0.5, "Uniform: p=0.5"},
      {1.0, 1.0, 0.75, 0.75, "Uniform: p=0.75"},

      # Symmetric cases {a=b}
      {2.0, 2.0, 0.5, 0.5, "Symmetric: a=b=2, median"},
      {3.0, 3.0, 0.5, 0.5, "Symmetric: a=b=3, median"},
      {5.0, 5.0, 0.5, 0.5, "Symmetric: a=b=5, median"},
      {2.0, 2.0, 0.25, 0.3263518223330697, "Symmetric: a=b=2, lower quartile"},
      {2.0, 2.0, 0.75, 0.6736481776669303, "Symmetric: a=b=2, upper quartile"},

      # Small a, moderate b {left-skewed}
      {0.5, 2.0, 0.1, 0.004457681887621376, "Small a: a=0.5, b=2"},
      {0.5, 2.0, 0.5, 0.12061475842818319, "Small a: a=0.5, b=2, median"},
      {0.5, 5.0, 0.5, 0.0466872453369664, "Small a: a=0.5, b=5, median"},
      {1.0, 3.0, 0.5, 0.20629947401590035, "Small a: a=1, b=3, median"},

      # Moderate a, small b {right-skewed}
      {2.0, 0.5, 0.5, 0.8793852415718169, "Small b: a=2, b=0.5, median"},
      {3.0, 1.0, 0.5, 0.7937005259840997, "Small b: a=3, b=1, median"},
      {5.0, 0.5, 0.5, 0.9533127546630336, "Small b: a=5, b=0.5, median"},

      # Both parameters small {U-shaped}
      {0.5, 0.5, 0.1, 0.024471741852423214, "U-shaped: a=b=0.5, p=0.1"},
      {0.5, 0.5, 0.5, 0.4999999999999999, "U-shaped: a=b=0.5, median"},
      {0.5, 0.5, 0.9, 0.9755282581475768, "U-shaped: a=b=0.5, p=0.9"},
      {0.3, 0.7, 0.5, 0.15877468697850153, "U-shaped: a=0.3, b=0.7"},

      # Both parameters large {concentrated}
      {10.0, 10.0, 0.5, 0.5, "Large params: a=b=10, median"},
      {20.0, 20.0, 0.5, 0.49999999999999994, "Large params: a=b=20, median"},
      {10.0, 30.0, 0.5, 0.24580106752001296, "Large params: a=10, b=30"},
      {50.0, 50.0, 0.1, 0.43602641907249107, "Large params: a=b=50, p=0.1"},
      {50.0, 50.0, 0.9, 0.563973580927509, "Large params: a=b=50, p=0.9"},

      # One large, one small
      {0.5, 10.0, 0.5, 0.023051418325296138, "Mixed: a=0.5, b=10"},
      {10.0, 0.5, 0.5, 0.9769485816747039, "Mixed: a=10, b=0.5"},
      {1.0, 10.0, 0.5, 0.06696700846319262, "Mixed: a=1, b=10"},
      {10.0, 1.0, 0.5, 0.9330329915368074, "Mixed: a=10, b=1"},

      # Extreme tails {testing numerical precision}
      {2.0, 2.0, 0.01, 0.058903135778195254, "Extreme tail: p=0.01"},
      {2.0, 2.0, 0.99, 0.9410968642218047, "Extreme tail: p=0.99"},
      {5.0, 5.0, 0.001, 0.10252344780625376, "Extreme tail: p=0.001"},
      {5.0, 5.0, 0.999, 0.8974765521937462, "Extreme tail: p=0.999"},
      {10.0, 10.0, 0.0001, 0.14385151398467935, "Very extreme: p=0.0001"},
      {10.0, 10.0, 0.9999, 0.8561484860153225, "Very extreme: p=0.9999"},

      # Asymmetric cases
      {2.0, 5.0, 0.3, 0.18180347131894917, "Asymmetric: a=2, b=5"},
      {2.0, 5.0, 0.7, 0.36035769038002013, "Asymmetric: a=2, b=5"},
      {5.0, 2.0, 0.3, 0.6396423096199798, "Asymmetric: a=5, b=2"},
      {3.0, 7.0, 0.5, 0.28623666802278286, "Asymmetric: a=3, b=7"},

      # Integer-like parameters {common in Bayesian applications}
      {3.0, 8.0, 0.5, 0.25857472328496317, "Bayesian-like: a=3, b=8"},
      {15.0, 5.0, 0.5, 0.7584574497236709, "Bayesian-like: a=15, b=5"},
      {100.0, 200.0, 0.5, 0.3329625066484857, "Large Bayesian: a=100, b=200"},

      # Very asymmetric
      {1.0, 20.0, 0.5, 0.03406367107515447, "Very asymmetric: a=1, b=20"},
      {20.0, 1.0, 0.5, 0.9659363289248455, "Very asymmetric: a=20, b=1"},
      {0.1, 10.0, 0.5, 6.210520703091691e-05, "Extreme asymmetric: a=0.1, b=10"},

      # Additional challenging cases
      {0.2, 0.8, 0.5, 0.04329908929545435, "Both small, asymmetric"},
      {100.0, 100.0, 0.5, 0.5, "Very large symmetric"},
      {1.5, 3.5, 0.25, 0.14991308950571583, "Non-integer moderate"},
      {7.5, 2.5, 0.75, 0.8497421060839618, "Non-integer asymmetric"}
    ]

    for {a, b, p, expected, _description} <- test_cases do
      assert_in_delta(Math.inv_incomplete_beta(a, b, p), expected, 0.0001)
    end
  end

  test "test inverse error function" do
    test_cases = [
      {0.0128205128205128, -2.23160583526092},
      {0.0256410256410256, -1.94911199693989},
      {0.0384615384615385, -1.76882503851871},
      {0.0512820512820513, -1.63254796584635},
      {0.0641025641025641, -1.52121804642593},
      {0.0769230769230769, -1.42607687227285},
      {0.0897435897435897, -1.34233568007726},
      {0.102564102564103, -1.26707575126644},
      {0.115384615384615, -1.19837970230692},
      {0.128205128205128, -1.13491661799349},
      {0.141025641025641, -1.07572272256151},
      {0.153846153846154, -1.0200762327862},
      {0.166666666666667, -0.967421566101701},
      {0.17948717948718, -0.917321185619228},
      {0.192307692307692, -0.869423773288886},
      {0.205128205128205, -0.823442487223818},
      {0.217948717948718, -0.779139683672991},
      {0.230769230769231, -0.73631591737613},
      {0.243589743589744, -0.694801852365364},
      {0.256410256410256, -0.654452200732004},
      {0.269230769230769, -0.615141104595973},
      {0.282051282051282, -0.576758564507798},
      {0.294871794871795, -0.539207639325099},
      {0.307692307692308, -0.502402223373355},
      {0.32051282051282, -0.466265261370636},
      {0.333333333333333, -0.430727299295457},
      {0.346153846153846, -0.395725295814487},
      {0.358974358974359, -0.361201637711319},
      {0.371794871794872, -0.327103316347528},
      {0.384615384615385, -0.293381232121193},
      {0.397435897435897, -0.25998960123107},
      {0.41025641025641, -0.226885444535879},
      {0.423076923076923, -0.194028142423926},
      {0.435897435897436, -0.161379042734239},
      {0.448717948717949, -0.128901111149042},
      {0.461538461538462, -0.0965586152896392},
      {0.474358974358974, -0.0643168351238744},
      {0.487179487179487, -0.0321417933273384},
      {0.5, 0.0},
      {0.511904761904762, 0.029845242919239703},
      {0.523809523809524, 0.05971709978532317},
      {0.535714285714286, 0.08964235107576338},
      {0.547619047619048, 0.119648113039843},
      {0.55952380952381, 0.14976201244462803},
      {0.571428571428571, 0.18001236979270382},
      {0.583333333333333, 0.21042839424792395},
      {0.595238095238095, 0.24104039388602627},
      {0.607142857142857, 0.27188000539926044},
      {0.619047619047619, 0.3029804480562063},
      {0.630952380952381, 0.33437680758881444},
      {0.642857142857143, 0.36610635680057013},
      {0.654761904761905, 0.398208921133661},
      {0.666666666666667, 0.43072729929545833},
      {0.678571428571429, 0.4637077514571804},
      {0.69047619047619, 0.49720057068155277},
      {0.702380952380952, 0.5312607573635734},
      {0.714285714285714, 0.5659488219328622},
      {0.726190476190476, 0.6013317483706246},
      {0.738095238095238, 0.6374841609623768},
      {0.75, 0.6744897501960817},
      {0.761904761904762, 0.7124430323894891},
      {0.773809523809524, 0.7514515438490056},
      {0.785714285714286, 0.7916386077433757},
      {0.797619047619048, 0.8331468660796111},
      {0.80952380952381, 0.8761428492468425},
      {0.821428571428571, 0.920822976368377},
      {0.833333333333333, 0.9674215661016998},
      {0.845238095238095, 1.0162217327405558},
      {0.857142857142857, 1.0675705238781408},
      {0.869047619047619, 1.1219004674623516},
      {0.880952380952381, 1.1797611176118616},
      {0.892857142857143, 1.2418667918433213},
      {0.904761904761905, 1.3091717167857786},
      {0.916666666666667, 1.3829941271006403},
      {0.928571428571429, 1.4652337926855261},
      {0.94047619047619, 1.5587835495029916},
      {0.952380952380952, 1.6683911939470755},
      {0.964285714285714, 1.8027430907391861},
      {0.976190476190476, 1.9807523966472764},
      {0.988095238095238, 2.260188991329373}
    ]

    for {p, expected} <- test_cases do
      assert_in_delta(Math.inv_cdf_standard_normal(p), expected, 0.000000001)
    end
  end

  test "test cdf_standard_normal" do
    test_cases = [
      {-8, 6.106226635438361e-16},
      {-7, 1.2798095916366492e-12},
      {-6, 9.865876449133282e-10},
      {-5.207297298141723, 9.58054838795519e-08},
      {-5.155224325160306, 1.2666373833125633e-07},
      {-5.103151352178889, 1.6702181565575458e-07},
      {-5.051078379197472, 2.196613714255946e-07},
      {-4.999005406216055, 2.8813393643245533e-07},
      {-4.946932433234638, 3.7696065391390476e-07},
      {-4.894859460253221, 4.918800313724603e-07},
      {-4.842786487271803, 6.401542180234365e-07},
      {-4.790713514290386, 8.309463542799378e-07},
      {-4.7386405413089685, 1.075783904846972e-06},
      {-4.686567568327551, 1.3891256196441049e-06},
      {-4.634494595346134, 1.7890529098174568e-06},
      {-4.582421622364717, 2.2981100107344332e-06},
      {-4.5303486493833, 2.94432137920575e-06},
      {-4.478275676401882, 3.7624193642837866e-06},
      {-4.426202703420465, 4.795320337980247e-06},
      {-4.374129730439048, 6.0958931932253435e-06},
      {-4.322056757457631, 7.729070433060148e-06},
      {-4.269983784476214, 9.774358983860587e-06},
      {-4.2179108114947965, 1.2328815360451717e-05},
      {-4.165837838513379, 1.551055785692368e-05},
      {-4.113764865531961, 1.94628969824584e-05},
      {-4.061691892550544, 2.435917432219714e-05},
      {-4.009618919569127, 3.0408409269433445e-05},
      {-3.95754594658771, 3.786186249410406e-05},
      {-3.905472973606293, 4.702063439726567e-05},
      {-3.8534000006248754, 5.8244425913012154e-05},
      {-3.8013270276434583, 7.19615975816601e-05},
      {-3.749254054662041, 8.868067049039308e-05},
      {-3.697181081680624, 0.00010900341907749134},
      {-3.6451081086992065, 0.00013363971048530043},
      {-3.5930351357177894, 0.00016342424762583185},
      {-3.5409621627363723, 0.00019933537286276337},
      {-3.4888891897549548, 0.00024251608561526306},
      {-3.4368162167735377, 0.0002942974196473158},
      {-3.3847432437921205, 0.00035622431366494345},
      {-3.3326702708107034, 0.00043008409145528503},
      {-3.280597297829286, 0.0005179376445150763},
      {-3.2285243248478688, 0.0006221533803101309},
      {-3.1764513518664517, 0.0007454439624148268},
      {-3.124378378885034, 0.0008909058243070644},
      {-3.072305405903617, 0.001062061386157942},
      {-3.0202324329222, 0.0012629038433084605},
      {-2.968159459940783, 0.0014979443261979308},
      {-2.9160864869593652, 0.0017722611544309652},
      {-2.864013513977948, 0.002091550822814925},
      {-2.811940540996531, 0.002462180265206837},
      {-2.7598675680151135, 0.0028912398438191156},
      {-2.7077945950336963, 0.0033865964085064704},
      {-2.6557216220522792, 0.003956945664089051},
      {-2.6036486490708617, 0.004611862975905268},
      {-2.5515756760894446, 0.005361851636818349},
      {-2.4995027031080275, 0.006218387515451618},
      {-2.4474297301266104, 0.007193958908423337},
      {-2.395356757145193, 0.008302100332000961},
      {-2.3432837841637757, 0.009557418914310167},
      {-2.2912108111823586, 0.010975611991591083},
      {-2.239137838200941, 0.012573474474621649},
      {-2.187064865219524, 0.014368894537949928},
      {-2.134991892238107, 0.016380836198456428},
      {-2.0829189192566897, 0.018629307394237016},
      {-2.030845946275272, 0.021135312252704486},
      {-1.978772973293855, 0.023920786350486223},
      {-1.9267000003124377, 0.02700851391886211},
      {-1.8746270273310206, 0.03042202613807521},
      {-1.8225540543496033, 0.03418547989193138},
      {-1.7704810813681862, 0.03832351661976774},
      {-1.7184081083867688, 0.04286110120413861},
      {-1.6663351354053517, 0.04782334116634546},
      {-1.6142621624239344, 0.0532352868039766},
      {-1.562189189442517, 0.05912171328952742},
      {-1.5101162164611, 0.06550688615043276},
      {-1.4580432434796826, 0.07241431196092496},
      {-1.4059702704982655, 0.07986647648656836},
      {-1.3538972975168482, 0.08788457292391011},
      {-1.3018243245354308, 0.09648822326061923},
      {-1.2497513515540137, 0.10569519613565614},
      {-1.1976783785725964, 0.11552112489418975},
      {-1.1456054055911793, 0.12597922979815046},
      {-1.093532432609762, 0.13708004856094402},
      {-1.0414594596283449, 0.1488311795152048},
      {-0.9893864866469275, 0.1612370417879111},
      {-0.9373135136655103, 0.17429865684142026},
      {-0.8852405406840931, 0.18801345563741279},
      {-0.8331675677026759, 0.20237511549056547},
      {-0.7810945947212585, 0.21737343039933282},
      {-0.7290216217398413, 0.23299421827396055},
      {-0.6769486487584241, 0.2492192680305551},
      {-0.6248756757770069, 0.2660263289906894},
      {-0.5728027027955896, 0.2833891444268924},
      {-0.5207297298141724, 0.3012775304357501},
      {-0.46865675683275515, 0.3196575006144551},
      {-0.41658378385133793, 0.3384914362773036},
      {-0.36451081086992065, 0.3577383011909926},
      {-0.31243783788850343, 0.3773538990476636},
      {-0.2603648649070862, 0.3972911711490689},
      {-0.20829189192566896, 0.4175005310606497},
      {-0.15621891894425172, 0.4379302323269991},
      {-0.10414594596283448, 0.458526764735602},
      {-0.05207297298141724, 0.47923527408808453},
      {0.0, 0.5},
      {0.05207297298141724, 0.5207647259119155},
      {0.10414594596283448, 0.5414732352643981},
      {0.15621891894425172, 0.5620697676730009},
      {0.20829189192566896, 0.5824994689393502},
      {0.2603648649070862, 0.602708828850931},
      {0.31243783788850343, 0.6226461009523364},
      {0.36451081086992065, 0.6422616988090074},
      {0.41658378385133793, 0.6615085637226964},
      {0.46865675683275515, 0.6803424993855449},
      {0.5207297298141724, 0.6987224695642499},
      {0.5728027027955896, 0.7166108555731077},
      {0.6248756757770069, 0.7339736710093105},
      {0.6769486487584241, 0.7507807319694448},
      {0.7290216217398413, 0.7670057817260394},
      {0.7810945947212585, 0.7826265696006671},
      {0.8331675677026759, 0.7976248845094345},
      {0.8852405406840931, 0.8119865443625872},
      {0.9373135136655103, 0.8257013431585798},
      {0.9893864866469275, 0.8387629582120889},
      {1.0414594596283449, 0.8511688204847951},
      {1.093532432609762, 0.862919951439056},
      {1.1456054055911793, 0.8740207702018495},
      {1.1976783785725964, 0.8844788751058102},
      {1.2497513515540137, 0.8943048038643439},
      {1.3018243245354308, 0.9035117767393808},
      {1.3538972975168482, 0.9121154270760898},
      {1.4059702704982655, 0.9201335235134316},
      {1.4580432434796826, 0.927585688039075},
      {1.5101162164611, 0.9344931138495672},
      {1.562189189442517, 0.9408782867104726},
      {1.6142621624239344, 0.9467647131960234},
      {1.6663351354053517, 0.9521766588336545},
      {1.7184081083867688, 0.9571388987958613},
      {1.7704810813681862, 0.9616764833802323},
      {1.8225540543496033, 0.9658145201080686},
      {1.8746270273310206, 0.9695779738619248},
      {1.9267000003124377, 0.972991486081138},
      {1.978772973293855, 0.9760792136495138},
      {2.030845946275272, 0.9788646877472955},
      {2.0829189192566897, 0.981370692605763},
      {2.134991892238107, 0.9836191638015436},
      {2.187064865219524, 0.9856311054620501},
      {2.239137838200941, 0.9874265255253784},
      {2.2912108111823586, 0.9890243880084089},
      {2.3432837841637757, 0.9904425810856898},
      {2.395356757145193, 0.991697899667999},
      {2.4474297301266104, 0.9928060410915767},
      {2.4995027031080275, 0.9937816124845484},
      {2.5515756760894446, 0.9946381483631817},
      {2.6036486490708617, 0.9953881370240947},
      {2.6557216220522792, 0.9960430543359109},
      {2.7077945950336963, 0.9966134035914935},
      {2.7598675680151135, 0.9971087601561809},
      {2.811940540996531, 0.9975378197347932},
      {2.864013513977948, 0.997908449177185},
      {2.9160864869593652, 0.998227738845569},
      {2.968159459940783, 0.998502055673802},
      {3.0202324329222, 0.9987370961566915},
      {3.072305405903617, 0.9989379386138421},
      {3.124378378885034, 0.9991090941756929},
      {3.1764513518664517, 0.9992545560375852},
      {3.2285243248478688, 0.9993778466196899},
      {3.280597297829286, 0.999482062355485},
      {3.3326702708107034, 0.9995699159085447},
      {3.3847432437921205, 0.999643775686335},
      {3.4368162167735377, 0.9997057025803526},
      {3.4888891897549548, 0.9997574839143848},
      {3.5409621627363723, 0.9998006646271372},
      {3.5930351357177894, 0.9998365757523742},
      {3.6451081086992065, 0.9998663602895147},
      {3.697181081680624, 0.9998909965809225},
      {3.749254054662041, 0.9999113193295096},
      {3.8013270276434583, 0.9999280384024183},
      {3.8534000006248754, 0.999941755574087},
      {3.905472973606293, 0.9999529793656028},
      {3.95754594658771, 0.9999621381375059},
      {4.009618919569127, 0.9999695915907305},
      {4.061691892550544, 0.9999756408256778},
      {4.113764865531961, 0.9999805371030175},
      {4.165837838513379, 0.999984489442143},
      {4.2179108114947965, 0.9999876711846396},
      {4.269983784476214, 0.9999902256410161},
      {4.322056757457631, 0.999992270929567},
      {4.374129730439048, 0.9999939041068068},
      {4.426202703420465, 0.9999952046796621},
      {4.478275676401882, 0.9999962375806357},
      {4.5303486493833, 0.9999970556786208},
      {4.582421622364717, 0.9999977018899893},
      {4.634494595346134, 0.9999982109470902},
      {4.686567568327551, 0.9999986108743804},
      {4.7386405413089685, 0.9999989242160952},
      {4.790713514290386, 0.9999991690536457},
      {4.842786487271803, 0.9999993598457819},
      {4.894859460253221, 0.9999995081199686},
      {4.946932433234638, 0.9999996230393461},
      {4.999005406216055, 0.9999997118660635},
      {5.051078379197472, 0.9999997803386286},
      {5.103151352178889, 0.9999998329781843},
      {5.155224325160306, 0.9999998733362616}
    ]

    for {x, expected} <- test_cases do
      assert_in_delta(Math.cdf_standard_normal(x), expected, 0.0001)
    end
  end
end
