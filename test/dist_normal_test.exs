defmodule DistNormalTest do
  alias Test.Support.DistHelper
  alias Test.Support.Helper
  use ExUnit.Case

  test "test normal icdf across a range of values " do
    icdf_test_cases = [
      {52.46, 269.55597, 0.025, -475.85999301775945},
      {52.46, 269.55597, 0.5, 52.46},
      {52.46, 269.55597, 0.0975, -296.8653572047102},
      {52.46, 269.55597, 0.99, 679.5409577445167},
      {215.62, 376.30489, 0.01, -659.7960808426724},
      {215.62, 376.30489, 0.025, -521.9240316063069},
      {215.62, 376.30489, 0.5, 215.62},
      {215.62, 376.30489, 0.0975, -272.0443619398568},
      {215.62, 376.30489, 0.99, 1091.0360808426724},
      {247.34, 80.72943, 0.01, 59.53526214697115},
      {247.34, 80.72943, 0.025, 89.1132247075526},
      {247.34, 80.72943, 0.5, 247.34},
      {247.34, 80.72943, 0.0975, 142.72040292083813},
      {247.34, 80.72943, 0.99, 435.14473785302886},
      {11.49, 47.75193, 0.01, -99.59760083684705},
      {11.49, 47.75193, 0.025, -82.10206299227777},
      {11.49, 47.75193, 0.5, 11.49},
      {11.49, 47.75193, 0.0975, -50.39310355160866},
      {11.49, 47.75193, 0.99, 122.57760083684704},
      {-3.37, 33.18611, 0.01, -80.57243644618549},
      {-3.37, 33.18611, 0.025, -68.41358038698455},
      {-3.37, 33.18611, 0.5, -3.37},
      {-3.37, 33.18611, 0.0975, -46.37683724417161},
      {-3.37, 33.18611, 0.99, 73.83243644618548},
      {-360.13, 67.98925, 0.01, -518.2966471951312},
      {-360.13, 67.98925, 0.025, -493.3864813358899},
      {-360.13, 67.98925, 0.5, -360.13},
      {-360.13, 67.98925, 0.0975, -448.23923031061173},
      {-360.13, 67.98925, 0.99, -201.96335280486878},
      {-344.87, 1220.6818, 0.01, -3184.6005103103466},
      {-344.87, 1220.6818, 0.025, -2737.362364583526},
      {-344.87, 1220.6818, 0.5, -344.87},
      {-344.87, 1220.6818, 0.0975, -1926.786756725101},
      {-344.87, 1220.6818, 0.99, 2494.860510310347},
      {290.15, 38.88852, 0.01, 199.68177417340524},
      {290.15, 38.88852, 0.025, 213.92990138793436},
      {290.15, 38.88852, 0.5, 290.15},
      {290.15, 38.88852, 0.0975, 239.75324514362444},
      {290.15, 38.88852, 0.99, 380.6182258265947},
      {139.39, 6.77793, 0.01, 123.62217695410236},
      {139.39, 6.77793, 0.025, 126.10550131026642},
      {139.39, 6.77793, 0.5, 139.39},
      {139.39, 6.77793, 0.0975, 130.60628499506606},
      {139.39, 6.77793, 0.99, 155.15782304589763},
      {128.3, 271.18625, 0.01, -502.5735561566078},
      {128.3, 271.18625, 0.025, -403.2152831024753},
      {128.3, 271.18625, 0.5, 128.3},
      {128.3, 271.18625, 0.0975, -223.13808408419163},
      {128.3, 271.18625, 0.99, 759.1735561566079},
      {-216.33, 493.24035, 0.01, -1363.77863961366},
      {-216.33, 493.24035, 0.025, -1183.063321721931},
      {-216.33, 493.24035, 0.5, -216.33},
      {-216.33, 493.24035, 0.0975, -855.5343977045891},
      {-216.33, 493.24035, 0.99, 931.1186396136601},
      {431.41, 179.74496, 0.01, 13.260694434444076},
      {431.41, 179.74496, 0.025, 79.11635199740732},
      {431.41, 179.74496, 0.5, 431.41},
      {431.41, 179.74496, 0.0975, 198.47332136607346},
      {431.41, 179.74496, 0.99, 849.559305565556},
      {-159.2, 398.83142, 0.01, -1087.0206260176897},
      {-159.2, 398.83142, 0.025, -940.895219102968},
      {-159.2, 398.83142, 0.5, -159.2},
      {-159.2, 398.83142, 0.0975, -676.0571419730077},
      {-159.2, 398.83142, 0.99, 768.6206260176896},
      {-349.85, 1072.27556, 0.01, -2844.335969391952},
      {-349.85, 1072.27556, 0.025, -2451.471479102518},
      {-349.85, 1072.27556, 0.5, -349.85},
      {-349.85, 1072.27556, 0.0975, -1739.4428293440533},
      {-349.85, 1072.27556, 0.99, 2144.635969391952},
      {439.55, 687.63573, 0.01, -1160.1299186000215},
      {439.55, 687.63573, 0.025, -908.1912652829092},
      {439.55, 687.63573, 0.5, 439.55},
      {439.55, 687.63573, 0.0975, -451.5769782263463},
      {439.55, 687.63573, 0.99, 2039.2299186000214},
      {264.15, 1233.91062, 0.01, -2606.355347593416},
      {264.15, 1233.91062, 0.025, -2154.2703753414894},
      {264.15, 1233.91062, 0.5, 264.15},
      {264.15, 1233.91062, 0.0975, -1334.910366165088},
      {264.15, 1233.91062, 0.99, 3134.655347593416},
      {182.95, 30.69807, 0.01, 111.53561011834307},
      {182.95, 30.69807, 0.025, 122.78288840511047},
      {182.95, 30.69807, 0.5, 182.95},
      {182.95, 30.69807, 0.0975, 143.16748556247816},
      {182.95, 30.69807, 0.99, 254.3643898816569},
      {-379.14, 257.44182, 0.01, -978.0392306462048},
      {-379.14, 257.44182, 0.025, -883.7166953144435},
      {-379.14, 257.44182, 0.5, -379.14},
      {-379.14, 257.44182, 0.0975, -712.7662807717845},
      {-379.14, 257.44182, 0.99, 219.75923064620486},
      {368.35, 263.99327, 0.01, -245.7901824255896},
      {368.35, 263.99327, 0.025, -149.06730136095837},
      {368.35, 263.99327, 0.5, 368.35},
      {368.35, 263.99327, 0.0975, 26.233506188382705},
      {368.35, 263.99327, 0.99, 982.4901824255896},
      {-197.1, 947.65636, 0.01, -2401.6783584072814},
      {-197.1, 947.65636, 0.025, -2054.4723353203244},
      {-197.1, 947.65636, 0.5, -197.1},
      {-197.1, 947.65636, 0.0975, -1425.1952132661556},
      {-197.1, 947.65636, 0.99, 2007.4783584072816}
    ]

    for {mu, sigma, p, expected} <- icdf_test_cases do
      assert_in_delta(
        Dist.normal(mu, sigma) |> Dist.icdf(p),
        expected,
        0.000001
      )
    end
  end

  test "test normal cdf across a range of values" do
    cdf_test_cases = [
      {52.46, 269.55597, -1923.0, 1.1631006573854086e-13},
      {52.46, 269.55597, -4, 0.4170463070873069},
      {52.46, 269.55597, 20.0, 0.452075121499917},
      {52.46, 269.55597, 821, 0.9978218148267666},
      {52.46, 269.55597, 10000.0, 1.0},
      {215.62, 376.30489, -1923.0, 6.609459930180386e-09},
      {215.62, 376.30489, -4, 0.2797371600621057},
      {215.62, 376.30489, 20.0, 0.30158600569078},
      {215.62, 376.30489, 821, 0.9461643481014921},
      {215.62, 376.30489, 10000.0, 1.0},
      {247.34, 80.72943, -1923.0, 1.6839076156714614e-159},
      {247.34, 80.72943, -4, 0.0009248426036516974},
      {247.34, 80.72943, 20.0, 0.002430727961782421},
      {247.34, 80.72943, 821, 0.9999999999994026},
      {247.34, 80.72943, 10000.0, 1.0},
      {11.49, 47.75193, -1923.0, 0.0},
      {11.49, 47.75193, -4, 0.3728233650695395},
      {11.49, 47.75193, 20.0, 0.5707220288021658},
      {11.49, 47.75193, 821, 1.0},
      {11.49, 47.75193, 10000.0, 1.0},
      {-3.37, 33.18611, -1923.0, 0.0},
      {-3.37, 33.18611, -4, 0.4924269960756307},
      {-3.37, 33.18611, 20.0, 0.7593490867227339},
      {-3.37, 33.18611, 821, 1.0},
      {-3.37, 33.18611, 10000.0, 1.0},
      {-360.13, 67.98925, -1923.0, 3.1432091526568836e-117},
      {-360.13, 67.98925, -4, 0.9999999188518955},
      {-360.13, 67.98925, 20.0, 0.9999999887137322},
      {-360.13, 67.98925, 821, 1.0},
      {-360.13, 67.98925, 10000.0, 1.0},
      {-344.87, 1220.6818, -1923.0, 0.09803550513093195},
      {-344.87, 1220.6818, -4, 0.6099718176247133},
      {-344.87, 1220.6818, 20.0, 0.6174943924022217},
      {-344.87, 1220.6818, 821, 0.8302357753798912},
      {-344.87, 1220.6818, 10000.0, 1.0},
      {290.15, 38.88852, -1923.0, 0.0},
      {290.15, 38.88852, -4, 1.9553678778118797e-14},
      {290.15, 38.88852, 20.0, 1.86858658733232e-12},
      {290.15, 38.88852, 821, 1.0},
      {290.15, 38.88852, 10000.0, 1.0},
      {139.39, 6.77793, -1923.0, 0.0},
      {139.39, 6.77793, -4, 1.2297757088657604e-99},
      {139.39, 6.77793, 20.0, 9.52954216515406e-70},
      {139.39, 6.77793, 821, 1.0},
      {139.39, 6.77793, 10000.0, 1.0},
      {128.3, 271.18625, -1923.0, 1.9516837333767724e-14},
      {128.3, 271.18625, -4, 0.312825711121981},
      {128.3, 271.18625, 20.0, 0.3448152593660423},
      {128.3, 271.18625, 821, 0.9946804280945317},
      {128.3, 271.18625, 10000.0, 1.0},
      {-216.33, 493.24035, -1923.0, 0.00026996898222720136},
      {-216.33, 493.24035, -4, 0.6665766658597885},
      {-216.33, 493.24035, 20.0, 0.6840796305860741},
      {-216.33, 493.24035, 821, 0.9822711506180632},
      {-216.33, 493.24035, 10000.0, 1.0},
      {431.41, 179.74496, -1923.0, 1.6766075882247857e-39},
      {431.41, 179.74496, -4, 0.007709679063673758},
      {431.41, 179.74496, 20.0, 0.011043913620865799},
      {431.41, 179.74496, 821, 0.9849000994048396},
      {431.41, 179.74496, 10000.0, 1.0},
      {-159.2, 398.83142, -1923.0, 4.88007738994994e-06},
      {-159.2, 398.83142, -4, 0.6514125401237542},
      {-159.2, 398.83142, 20.0, 0.67339693118499},
      {-159.2, 398.83142, 821, 0.9930081140901609},
      {-159.2, 398.83142, 10000.0, 1.0},
      {-349.85, 1072.27556, -1923.0, 0.07117258478006244},
      {-349.85, 1072.27556, -4, 0.6264775587628894},
      {-349.85, 1072.27556, 20.0, 0.6349229930373702},
      {-349.85, 1072.27556, 821, 0.8625680951616584},
      {-349.85, 1072.27556, 10000.0, 1.0},
      {439.55, 687.63573, -1923.0, 0.00029544920525314557},
      {439.55, 687.63573, -4, 0.2594518343892987},
      {439.55, 687.63573, 20.0, 0.2708864932036129},
      {439.55, 687.63573, 821, 0.7104592447850282},
      {439.55, 687.63573, 10000.0, 1.0},
      {264.15, 1233.91062, -1923.0, 0.03815287928665358},
      {264.15, 1233.91062, -4, 0.41398057717218983},
      {264.15, 1233.91062, 20.0, 0.4215746230105141},
      {264.15, 1233.91062, 821, 0.674109279461781},
      {264.15, 1233.91062, 10000.0, 0.9999999999999984},
      {182.95, 30.69807, -1923.0, 0.0},
      {182.95, 30.69807, -4, 5.646966233213384e-10},
      {182.95, 30.69807, 20.0, 5.53713522505542e-08},
      {182.95, 30.69807, 821, 1.0},
      {182.95, 30.69807, 10000.0, 1.0},
      {-379.14, 257.44182, -1923.0, 1.005427218664716e-09},
      {-379.14, 257.44182, -4, 0.9274671478529672},
      {-379.14, 257.44182, 20.0, 0.9394782566861595},
      {-379.14, 257.44182, 821, 0.9999984326540007},
      {-379.14, 257.44182, 10000.0, 1.0},
      {368.35, 263.99327, -1923.0, 1.986211617707913e-18},
      {368.35, 263.99327, -4, 0.0792030382625204},
      {368.35, 263.99327, 20.0, 0.09349412055360617},
      {368.35, 263.99327, 821, 0.9567931863520641},
      {368.35, 263.99327, 10000.0, 1.0},
      {-197.1, 947.65636, -1923.0, 0.034285966428476054},
      {-197.1, 947.65636, -4, 0.5807317581396106},
      {-197.1, 947.65636, 20.0, 0.5906010931199497},
      {-197.1, 947.65636, 821, 0.8586636246991336},
      {-197.1, 947.65636, 10000.0, 1.0}
    ]

    for {mu, sigma, x, expected} <- cdf_test_cases do
      assert_in_delta(
        Dist.normal(mu, sigma) |> Dist.cdf(x),
        expected,
        0.000001
      )
    end
  end

  test "test normal pdf  across a range of values" do
    pdf_test_cases = [
      {52.46, 269.55597, -19023.0, 0.0},
      {52.46, 269.55597, -43, 0.0013900418442693747},
      {52.46, 269.55597, 6, 0.0014581771638843641},
      {52.46, 269.55597, 210.0, 0.0012476404185941768},
      {52.46, 269.55597, 1000.0, 3.069520859932566e-06},
      {215.62, 376.30489, -19023.0, 0.0},
      {215.62, 376.30489, -43, 0.0008371538775045163},
      {215.62, 376.30489, 6, 0.0009077971285459212},
      {215.62, 376.30489, 210.0, 0.0010600388206467924},
      {215.62, 376.30489, 1000.0, 0.00012075392258762995},
      {247.34, 80.72943, -19023.0, 0.0},
      {247.34, 80.72943, -43, 7.676885670444321e-06},
      {247.34, 80.72943, 6, 5.665255415212184e-05},
      {247.34, 80.72943, 210.0, 0.004440403766521205},
      {247.34, 80.72943, 1000.0, 6.589062372289743e-22},
      {11.49, 47.75193, -19023.0, 0.0},
      {11.49, 47.75193, -43, 0.00435679257977729},
      {11.49, 47.75193, 6, 0.008299442179139773},
      {11.49, 47.75193, 210.0, 1.4766455617845956e-06},
      {11.49, 47.75193, 1000.0, 7.379324906106788e-96},
      {-3.37, 33.18611, -19023.0, 0.0},
      {-3.37, 33.18611, -43, 0.005892375281379799},
      {-3.37, 33.18611, 6, 0.011551616741343723},
      {-3.37, 33.18611, 210.0, 1.2688985096917323e-11},
      {-3.37, 33.18611, 1000.0, 3.788183919082553e-201},
      {-360.13, 67.98925, -19023.0, 0.0},
      {-360.13, 67.98925, -43, 1.1067515429511761e-07},
      {-360.13, 67.98925, 6, 2.9601512778062143e-09},
      {-360.13, 67.98925, 210.0, 3.1556062011454247e-18},
      {-360.13, 67.98925, 1000.0, 7.336564823046896e-90},
      {-344.87, 1220.6818, -19023.0, 4.71046824176023e-55},
      {-344.87, 1220.6818, -43, 0.0003169770834916139},
      {-344.87, 1220.6818, 6, 0.0003135933138722286},
      {-344.87, 1220.6818, 210.0, 0.00029474069073796936},
      {-344.87, 1220.6818, 1000.0, 0.00017812672883660136},
      {290.15, 38.88852, -19023.0, 0.0},
      {290.15, 38.88852, -43, 1.187560341621955e-18},
      {290.15, 38.88852, 6, 2.6169523606354093e-14},
      {290.15, 38.88852, 210.0, 0.001226564118719793},
      {290.15, 38.88852, 1000.0, 4.571604090905087e-75},
      {139.39, 6.77793, -19023.0, 0.0},
      {139.39, 6.77793, -43, 3.389331191937356e-159},
      {139.39, 6.77793, 6, 4.6530712334171325e-86},
      {139.39, 6.77793, 210.0, 1.5975301369913346e-25},
      {139.39, 6.77793, 1000.0, 0.0},
      {128.3, 271.18625, -19023.0, 0.0},
      {128.3, 271.18625, -43, 0.001205034149255594},
      {128.3, 271.18625, 6, 0.0013288563759866001},
      {128.3, 271.18625, 210.0, 0.001405832139972044},
      {128.3, 271.18625, 1000.0, 8.394656022714782e-06},
      {-216.33, 493.24035, -19023.0, 1.6511e-319},
      {-216.33, 493.24035, -43, 0.0007603893912672835},
      {-216.33, 493.24035, 6, 0.000730687531881419},
      {-216.33, 493.24035, 210.0, 0.0005567013984984639},
      {-216.33, 493.24035, 1000.0, 3.866755821184047e-05},
      {431.41, 179.74496, -19023.0, 0.0},
      {431.41, 179.74496, -43, 6.816606109531957e-05},
      {431.41, 179.74496, 6, 0.00013486826817753973},
      {431.41, 179.74496, 210.0, 0.001039366178760018},
      {431.41, 179.74496, 1000.0, 1.4905807591719263e-05},
      {-159.2, 398.83142, -19023.0, 0.0},
      {-159.2, 398.83142, -43, 0.0009587117458955739},
      {-159.2, 398.83142, 6, 0.0009180466463965725},
      {-159.2, 398.83142, 210.0, 0.0006516899331413516},
      {-159.2, 398.83142, 1000.0, 1.464630004294959e-05},
      {-349.85, 1072.27556, -19023.0, 5.2171776568114766e-70},
      {-349.85, 1072.27556, -43, 0.00035712571262548046},
      {-349.85, 1072.27556, 6, 0.00035211812452676705},
      {-349.85, 1072.27556, 210.0, 0.0003246449712973808},
      {-349.85, 1072.27556, 1000.0, 0.00016845410229138604},
      {439.55, 687.63573, -19023.0, 6.434972276030609e-178},
      {439.55, 687.63573, -43, 0.00045354051232274315},
      {439.55, 687.63573, 6, 0.0004755878569380948},
      {439.55, 687.63573, 210.0, 0.0005487227049578935},
      {439.55, 687.63573, 1000.0, 0.0004162010470518398},
      {264.15, 1233.91062, -19023.0, 2.85120497183682e-57},
      {264.15, 1233.91062, -43, 0.0003134521348542409},
      {264.15, 1233.91062, 6, 0.00031631648225566083},
      {264.15, 1233.91062, 210.0, 0.00032300419584894324},
      {264.15, 1233.91062, 1000.0, 0.0002706450044552062},
      {182.95, 30.69807, -19023.0, 0.0},
      {182.95, 30.69807, -43, 2.2374274542468555e-14},
      {182.95, 30.69807, 6, 7.922264372720555e-10},
      {182.95, 30.69807, 210.0, 0.008814454603384187},
      {182.95, 30.69807, 1000.0, 1.9404734023031373e-156},
      {-379.14, 257.44182, -19023.0, 0.0},
      {-379.14, 257.44182, -43, 0.0006607404346936396},
      {-379.14, 257.44182, 6, 0.0005060975198891924},
      {-379.14, 257.44182, 210.0, 0.00011299017461285849},
      {-379.14, 257.44182, 1000.0, 9.087421372846086e-10},
      {368.35, 263.99327, -19023.0, 0.0},
      {368.35, 263.99327, -43, 0.00044884618345854033},
      {368.35, 263.99327, 6, 0.0005891437867677515},
      {368.35, 263.99327, 210.0, 0.0012623784268651491},
      {368.35, 263.99327, 1000.0, 8.633218470720754e-05},
      {-197.1, 947.65636, -19023.0, 8.46387583110841e-90},
      {-197.1, 947.65636, -43, 0.00041544855717876066},
      {-197.1, 947.65636, 6, 0.00041141972966362005},
      {-197.1, 947.65636, 210.0, 0.00038387154137006877},
      {-197.1, 947.65636, 1000.0, 0.0001895619056556343}
    ]

    for {mu, sigma, x, expected} <- pdf_test_cases do
      assert_in_delta(
        Dist.normal(mu, sigma) |> Dist.pdf(x),
        expected,
        0.000001
      )
    end
  end

  test "test random properties of normal variable hold " do
    msss = [
      {52.46, 269.55597},
      {215.62, 376.30489},
      {247.34, 80.72943},
      {11.49, 47.75193},
      {-3.37, 33.18611},
      {-360.13, 67.98925},
      {-344.87, 1220.6818},
      {290.15, 38.88852},
      {139.39, 6.77793},
      {128.3, 271.18625},
      {-216.33, 493.24035},
      {431.41, 179.74496},
      {-159.2, 398.83142},
      {-349.85, 1072.27556},
      {439.55, 687.63573},
      {264.15, 1233.91062},
      {182.95, 30.69807},
      {-379.14, 257.44182},
      {368.35, 263.99327},
      {-197.1, 947.65636}
    ]

    for {mu, sigma} <- msss do
      dist = Dist.normal(mu, sigma)
      assert dist |> DistHelper.has_correct_inverse_at_median()

      assert Helper.percentage_error(
               DistHelper.variance_of_random_samples(dist, 50000),
               Dist.variance(dist)
             ) < 0.05

      dist |> DistHelper.variance_of_random_samples(50000)
    end
  end
end
