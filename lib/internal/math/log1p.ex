defmodule Internal.Math.Log1p do
  alias Internal.Math.Chebyshev
  use Internal.Math.Constants

  @coefs {
    0.10378693562743769800686267719098e+1,
    -0.13364301504908918098766041553133e+0,
    0.19408249135520563357926199374750e-1,
    -0.30107551127535777690376537776592e-2,
    0.48694614797154850090456366509137e-3,
    -0.81054881893175356066809943008622e-4,
    0.13778847799559524782938251496059e-4,
    -0.23802210894358970251369992914935e-5,
    0.41640416213865183476391859901989e-6,
    -0.73595828378075994984266837031998e-7,
    0.13117611876241674949152294345011e-7,
    -0.23546709317742425136696092330175e-8,
    0.42522773276034997775638052962567e-9,
    -0.77190894134840796826108107493300e-10,
    0.14075746481359069909215356472191e-10,
    -0.25769072058024680627537078627584e-11,
    0.47342406666294421849154395005938e-12,
    -0.87249012674742641745301263292675e-13,
    0.16124614902740551465739833119115e-13,
    -0.29875652015665773006710792416815e-14,
    0.55480701209082887983041321697279e-15,
    -0.10324619158271569595141333961932e-15,
    +0.19250239203049851177878503244868e-16,
    -0.35955073465265150011189707844266e-17,
    +0.67264542537876857892194574226773e-18,
    -0.12602624168735219252082425637546e-18,
    +0.23644884408606210044916158955519e-19,
    -0.44419377050807936898878389179733e-20
  }

  @doc """
  Computes the natural logarithm of 1 + x, log(1+x)
  """
  @spec log1p(number()) :: number()
  def log1p(x) do
    unless x > -1 do
      raise ArgumentError,
        message: "log(1 + x) means that x must be greater than -1, you provided #{inspect(x)}"
    end

    xabs = abs(x)

    cond do
      x == 0 ->
        0

      # when 1+x is very close to x, the best estimate of log(1+x) is simply x
      xabs < @m_epsilon * 0.5 ->
        x

      (x >= 0 && x < 1.0e-8) or (x >= -1.0e-9 && x < 0) ->
        x * (1.0 - x * 0.5)

      xabs < 0.375 ->
        x * (1 - x * Chebyshev.echeb(x / 0.375, @coefs))

      true ->
        Math.log(1.0 + x)
    end
  end
end
